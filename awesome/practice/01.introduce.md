[toc]

## 调优标准

1. 目的:

   - 清楚系统能承受的极限{开发完一般都会压力测试, 性能测试等}
   - 节约资源 + 稳定运行 + 用户体验(RT)

2. 原因

   - [少]时间上的技术债引起的小问题的迭代
   - [多]访问量的波动

3. 时机

   - 初期都是关注功能: 先实现在完美{快速迭代小步快跑}
   - 但要做到有效编码: `关联到 dp 中的优秀代码`
   - 时机: `完成功能之后`

4. **性能指标**: 迭代之前的性能作为参考

   - 项目
     1. 连接
     2. `异常`消耗资源
     3. 线程池
     4. jvm
     5. 锁竞争
     6. 异常率
     7. **吞吐量**
        - 系统吞吐量: QPS/TPS
        - 磁盘吞吐量
        - 网络吞吐量
     8. [**响应时间**](https://github.com/Alice52/java-ocean/issues/216)
        - 网络响应时间: 请求到达 lb 层 || gateway
        - 服务端响应时间: 分发请求到实例
        - **数据库响应时间**
        - 客户端响应时间
   - 依赖
     1. docker
     2. 数据库
     3. 框架
   - system
     1. CPU: 无限递归, 死循环, 频繁的 full gc, 线程上下文切换
     2. 内存: oom, leak
     3. 磁盘: IOPS(关注随机读写) + 数据吞吐量(顺序读写, 关注数据量)
     4. **网络**: 网卡 + 带宽 + 内部程序处理
     5. 负载承受能力: 阶段式加压, RT 等指标开始下降, 并抛出大量错误, 就说明系统已经达到极限
   - others
     1. 链路过长
     2. qps 太大
     3. 架构不合理

## 调优策略

1. 流程

   - 测试
   - **分析**
   - 调优
   - 测试

2. 测试

   - 微基准性能测试

     1. 可以精准定位到某个模块或者某个方法的性能问题
     2. 适合性能对比: jmh

   - 宏基准性能测试

     1. 测试环境: 模拟线上环境`{环境隔离}`
     2. 测试场景: 混合场景, 单 API 场景
     3. 测试目标: 是否达到性能指标
        - 不达标: 优化
        - 已达标: 则加大测试的并发数, 探底接口的 TPS 等指标

   - 测试问题列表

     1. 热身问题： JIT
     2. 性能测试结果不稳定: 多次结果取平均
     3. 多 JVM 情况下的影响: 环境隔离

3. 分析: `自上向下排查, 自下向上优化`

   - 将测试结果的指标形成报告
   - 系统层面排查: io, cpu, me, net
   - 组件层面排查: docker 数据库等
   - 应用层面排查: jvm, connection, pool

4. 优化

   - 应用调优
     1. 优化代码
     2. 优化设计
     3. 优化算法
   - 系统调优
     1. OS 调优
     2. jvm 调优
     3. 组件调优
   - 策略
     1. 空间换时间
     2. 空间换时间

5. 兜底策略

   - 限流
   - 智能化横向扩容
   - 提前扩容: 高并发系统
